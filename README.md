
# 甜瓜游乐场 - 自动化搭建与布局工具链

本项目是一套为 **《甜瓜游乐场》** 设计的、经过全面重构的次世代自动化工具链。它将高层级的图谱设计稿，通过**一键式操作**，直接转化为功能完备、布局整洁的复杂机械或 AI 逻辑。

得益于全新的集成化架构和智能布局系统，您现在只需专注于 `graph.json` 中的创意设计，工具链将自动处理从节点创建、智能定位到精确连线的所有繁琐工作，最终生成可直接在游戏中加载的存档。

## ✨ 核心特性 (全新升级!)

- **声明式设计**：在一个清晰、简洁的 `graph.json` 文件中设计您的整个作品，所见即所得。
- **一键式生成**：告别多步操作！现在只需运行单个主脚本，即可完成从解析到生成存档的全部流程。
- **智能自动布局**：内置强大的布局引擎，可自动为所有节点计算最佳位置，确保生成的逻辑图整洁、无重叠，极大提升了可读性和美观度。
- **统一模块定义**：所有模块的配置（包括游戏内名称、端口、数据类型等）被统一整合进单个 `moduledef.json` 文件，管理和扩展模块变得前所未有地简单。
- **集成化代码库**：项目重构为内聚的函数调用，移除了旧版的子进程通信。这带来了更快的执行速度、更高的稳定性以及更便捷的二次开发体验。
- **精确端口连线**：完全按照您在图谱 `edges` 中指定的连接关系，精确地连接模块的输入/输出端口，并严格遵守端口顺序。

## 📂 文件结构说明

本工具链的结构已被大幅简化，核心文件如下：

- **主入口 (User-facing):**
  - `main.py`: **唯一的执行入口。** 该脚本负责编排和执行整个自动化工作流。

- **核心模块 (Internal Libraries):**
  - `add_module.py`, `chip_modifier.py` 等：现在作为内部库，提供节点创建、修改和连接等核心功能，由 `main.py` 直接调用。

- **配置与数据 (由用户提供):**
  - `graph.json`: **您的设计蓝图。** 在这里定义您作品的节点和连接关系。
  - `moduledef.json`: **统一模块词典 (核心)。** 此文件替代了旧的 `chip_names.json`, `allmod.json` 和 `datatype_map.json`。它将友好名称映射到游戏内部属性，并定义其端口、操作代码等所有信息。
  - `data.json`: 您的游戏存档底包（可以是一个只包含空 contraption 的存档）。

- **生成的文件 (脚本输出):**
  - `data_modified.json`: **最终的输出成果！** 这就是您构建完成的存档文件，可直接加载进游戏。
  - (临时文件如 `modules.json`, `output.json` 等已被内部数据流取代，不再生成。)

## 🚀 使用方法 (简化流程)

### 准备工作
- 已安装 Python 3.x 环境。
- 本项目无需安装任何第三方 Python 库。

### 第一步：准备您的配置文件

1.  **在 `moduledef.json` 中定义您的模块**:
    确保您设计中用到的所有模块都在此文件中被定义。这是工具链查找模块信息的唯一来源。

    *`moduledef.json` 示例:*
    ```json
    {
      "AddNumbersNodeViewModel": {
        "friendly_name": "加法器",
        "operation_type": 2304,
        "inputs": ["输入A", "输入B"],
        "outputs": ["A+B"],
        "default_gate_type": 2
      },
      "ConstantNodeViewModel": {
        "friendly_name": "常量",
        "operation_type": 257,
        "inputs": [],
        "outputs": ["输出"],
        "default_gate_type": 2
      }
    }
    ```

2.  **在 `graph.json` 中完成您的设计**:
    定义所有您需要的节点（模块）和边（连接）。请使用与 `moduledef.json` 中条目对应的 `friendly_name` 作为 `type`。

    *`graph.json` 示例:*
    ```json
    {
      "nodes": [
        { "id": "input_A", "type": "常量" },
        { "id": "input_B", "type": "常量" },
        { "id": "adder", "type": "加法器" }
      ],
      "edges": [
        { "from_node": "input_A", "from_port": "输出", "to_node": "adder", "to_port": "输入A" },
        { "from_node": "input_B", "from_port": "输出", "to_node": "adder", "to_port": "输入B" }
      ]
    }
    ```
3.  **提供基础存档**:
    - 将一个基础的 `data.json` 存档文件放置在脚本根目录。

### 第二步：一键运行

整个流程现在只需一条命令。

```bash
python main.py
```

脚本将自动执行所有步骤：解析设计图、创建并布局节点、连接端口，然后直接生成最终的 `data_modified.json`。

### 第三步：享受您的作品！

大功告成！现在，`data_modified.json` 文件已经包含了您完整构建且自动布局的机械。将其复制到您游戏的存档目录，然后在《甜瓜游乐场》中加载它吧。

## 💡 全新工作流解析

新的集成化工作流由 `main.py` 通过一系列高效的内部函数调用完成：

1.  **解析与初始化**: 读取 `graph.json` 和 `moduledef.json`，在内存中构建出完整的节点与连接图。同时，初始化自动布局引擎。
2.  **节点创建与布局**: 遍历图谱中的节点定义，调用 `add_module` 中的函数创建每个节点。在创建过程中，**自动布局引擎会为新节点分配合理的坐标**，避免混乱和重叠。
3.  **精确连接**: 遍历图谱中的边定义，调用连接函数，在内存中将已创建节点的端口精确地连接起来。
4.  **序列化与输出**: 将内存中最终成型的、包含所有节点、位置和连接信息的数据结构，完整地序列化并写入到 `data_modified.json` 文件中。

这种健壮的流水线设计确保了即便是拥有成千上万节点和连接的宏伟设计，也能够被可靠、快速且美观地构建完成。

## 🙏 致谢

本项目的诞生离不开甜瓜社区中早期探索者们的智慧和工作。他们的工具和想法为这个更集成、更自动化的工具链提供了坚实的基础和灵感。向所有为这个社区做出贡献的创造者们致以诚挚的感谢！